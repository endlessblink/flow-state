name: Deploy to VPS

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install Doppler CLI
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      # Fetch secrets and create .env for build
      - name: Fetch Secrets for Build
        run: doppler secrets download --no-file --format env > .env.production
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}

      # Build the app
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --ignore-scripts

      - name: Build Application
        run: npm run build
        env:
          NODE_ENV: production

      # Setup SSH
      - name: Prepare SSH Key
        run: |
            mkdir -p ~/.ssh/
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
            cat >> ~/.ssh/config << 'EOF'
            Host *
              ServerAliveInterval=30
              ServerAliveCountMax=20
              TCPKeepAlive=yes
            EOF

      # Deploy static files to production (NOT Docker!)
      # System Caddy serves from /var/www/flowstate
      - name: Deploy Static Files
        run: |
            # Deploy built files to web root
            # --exclude='updates/' preserves Tauri auto-updater artifacts (FEATURE-1194)
            rsync -avz --delete --exclude='updates/' \
              ./dist/ \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/flowstate/

      # One-time cleanup: Backup old .env file (TASK-351)
      - name: Backup Legacy Env File
        run: |
            ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
              if [ -f /var/www/flowstate/.env ]; then
                echo 'Found legacy .env file, backing up...'
                mv /var/www/flowstate/.env /var/www/flowstate/.env.backup-pre-doppler
                echo '✓ Renamed to .env.backup-pre-doppler'
              else
                echo 'No legacy .env file found (already cleaned up or never existed)'
              fi
            "

      # Reload Caddy to pick up any potential changes (graceful, no downtime)
      - name: Reload Caddy
        run: |
            ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
              # Verify Caddy is running
              if ! systemctl is-active --quiet caddy; then
                echo 'Caddy is not running, starting it...'
                sudo systemctl start caddy
              else
                echo 'Caddy is running, reloading config...'
                sudo systemctl reload caddy
              fi

              # Verify Caddy is healthy
              sleep 2
              if systemctl is-active --quiet caddy; then
                echo '✓ Caddy is healthy'
              else
                echo '✗ Caddy failed to start!'
                exit 1
              fi
            "

      # Purge Cloudflare cache for mutable content (index.html only)
      # Fingerprinted assets (index-abc123.js) auto-invalidate via hash change
      - name: Purge Cloudflare Cache
        run: |
            echo "Purging Cloudflare cache for index.html, sw.js, and manifest..."

            # BUG-1089: Must purge sw.js to prevent stale ServiceWorker serving old asset hashes
            RESPONSE=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"files":["https://in-theflow.com/","https://in-theflow.com/index.html","https://in-theflow.com/sw.js","https://in-theflow.com/manifest.webmanifest"]}')

            # Check if purge succeeded
            SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
            if [ "$SUCCESS" != "true" ]; then
              echo "✗ Cloudflare cache purge failed!"
              echo "$RESPONSE" | jq .
              exit 1
            fi

            echo "✓ Cloudflare cache purged successfully"

            # Verify cache was purged (should get MISS or DYNAMIC)
            echo "Verifying cache status..."
            CF_STATUS=$(curl -sI "https://in-theflow.com/" | grep -i "cf-cache-status" | tr -d '\r')
            echo "  $CF_STATUS"

      # Validate CORS configuration after deployment
      - name: Validate CORS Configuration
        run: |
            echo "Waiting 10s for services to stabilize..."
            sleep 10
            chmod +x ./scripts/validate-cors.sh
            ./scripts/validate-cors.sh
        env:
          API_URL: https://api.in-theflow.com
          ORIGIN: https://in-theflow.com

      # Validate asset headers (prevents Cloudflare cache MIME type issues)
      - name: Validate Asset Headers
        run: |
            chmod +x ./scripts/validate-asset-headers.sh
            ./scripts/validate-asset-headers.sh
        env:
          DOMAIN: https://in-theflow.com

      # Health check
      - name: Verify Deployment
        run: |
            echo "Checking web app..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://in-theflow.com)
            if [ "$HTTP_CODE" != "200" ]; then
              echo "✗ Web app returned HTTP $HTTP_CODE"
              exit 1
            fi
            echo "✓ Web app is healthy (HTTP $HTTP_CODE)"

            echo "Checking API..."
            API_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api.in-theflow.com/rest/v1/)
            if [ "$API_CODE" != "401" ] && [ "$API_CODE" != "200" ]; then
              echo "✗ API returned unexpected HTTP $API_CODE"
              exit 1
            fi
            echo "✓ API is healthy (HTTP $API_CODE)"

      # BUG-1184: Verify every chunk referenced in index.html + main bundle actually loads.
      # Catches: stale assets after rsync --delete, partial deploys, SW/Cloudflare cache mismatches.
      - name: Verify Chunk Integrity
        run: |
            chmod +x ./scripts/validate-chunks.sh
            ./scripts/validate-chunks.sh
        env:
          DOMAIN: https://in-theflow.com
