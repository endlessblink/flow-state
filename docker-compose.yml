services:
  # 1. Postgres - The Source of Truth
  postgres:
    build:
      context: .
      dockerfile: Dockerfile.postgres
    container_name: pomoflow-postgres
    command: postgres -c wal_level=logical -c ssl=on -c ssl_cert_file=/etc/postgresql/server.crt -c ssl_key_file=/etc/postgresql/server.key
    environment:
      POSTGRES_DB: pomoflow
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d pomoflow"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Redis - Bucket State Storage
  redis:
    image: redis:7-alpine
    container_name: pomoflow-redis
    ports:
      - "6379:6379"

  # 3. PowerSync Service - The Sync Engine
  powersync:
    image: journeyapps/powersync-service:latest
    container_name: pomoflow-powersync
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      mongodb:
        condition: service_started
      sync-backend:
        condition: service_healthy
    environment:
      POWERSYNC_CONFIG_PATH: /etc/powersync/config.yaml
      NODE_TLS_REJECT_UNAUTHORIZED: 0
    ports:
      - "8080:8080"
    volumes:
      - ./powersync-config.yaml:/etc/powersync/config.yaml
      - ./sync-rules.yaml:/etc/powersync/sync-rules.yaml

  # 5. Sync Backend (Upstream + JWKS)
  sync-backend:
    build:
      context: .
      dockerfile: Dockerfile.sync-backend
    container_name: pomoflow-sync-backend
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/.well-known/jwks.json"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 4. MongoDB - Bucket Storage (Required for Open Edition)
  mongodb:
    image: mongo:6
    container_name: pomoflow-mongodb
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: echo "try { rs.status().ok } catch (e) { rs.initiate({_id:'rs0',members:[{_id:0,host:'localhost:27017'}]}); }" | mongosh --port 27017 --quiet
      interval: 5s
      timeout: 30s
      retries: 5

volumes:
  postgres_data:
  mongodb_data:
